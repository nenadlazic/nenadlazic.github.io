<!DOCTYPE html>
<html lang="en-us" class="m-auto  dark "><head>
  <title>Nenad Lazić</title>

<meta name="theme-color" content="" />
<meta charset="utf-8" />
<meta content="width=device-width, initial-scale=1.0" name="viewport" />
<meta name="description" content="Software Engineer — Portfolio, Blog &amp; Contact" />
<meta name="author" content="Nenad Lazić" />
<meta name="generator" content="aafu theme by Darshan in Hugo 0.147.3" />

        <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">        <link rel="manifest" href="/site.webmanifest">        <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#252627">        <link rel="shortcut icon" href="/favicon.ico">
  <link
    rel="stylesheet"
    href="https://use.fontawesome.com/releases/v5.15.2/css/all.css"
    integrity="sha384-vSIIfh2YWi9wW0r9iZe7RJPrKwp6bG+s9QZMoITbCckVJqGCCRhc+ccxNcdpHuYu"
    crossorigin="anonymous"
  />
  <link
    rel="stylesheet"
    href="https://cdn.rawgit.com/jpswalsh/academicons/master/css/academicons.min.css"
  />
  <link
    rel="stylesheet"
    href="//fonts.googleapis.com/css?family=Didact+Gothic%7CRoboto:400%7CRoboto+Mono"
  />

  
  
  
  <link
    rel="stylesheet"
    href="/main.min.5a53c8383b1597ebd74be77eae62ea636b5b6112fdee11d78aa0d8323d5d95eb.css"
    integrity="sha256-WlPIODsVl&#43;vXS&#43;d&#43;rmLqY2tbYRL97hHXiqDYMj1dles="
    crossorigin="anonymous"
  />
  

  <link href="/main.css" rel="stylesheet" />
  <link rel="stylesheet" href="/css/general.css" />
  <link rel="stylesheet" href="/css/search.css" />

  
    <meta property="og:image" content="https://nenadlazic.github.io/images/default-preview.png">
  

  <script>
    let html = document.querySelector("html");
    let theme = window.localStorage.getItem("theme");

    const setTheme = (theme) => {
      html.classList.remove("light");
      if (theme === "dark") {
        html.classList.add("dark");
        window.localStorage.setItem("theme", "dark");
      } else {
        html.classList.remove("dark");
        window.localStorage.setItem("theme", "light");
      }
      fixThemeToggleIcon(theme);
    };

    const fixThemeToggleIcon = (theme) => {
      let themeToggle = document.querySelector(".theme-toggle");
      if (themeToggle) {
        if (theme === "dark") {
          themeToggle.classList.remove("fa-moon");
          themeToggle.classList.add("fa-sun");
        } else {
          themeToggle.classList.remove("fa-sun");
          themeToggle.classList.add("fa-moon");
        }
      }
    };

    if (theme == null) {
      if (html.classList.contains("dark")) {
        theme = "dark";
      } else if (html.classList.contains("light")) {
        theme = "light";
      } else {
        
        const prefersDark = window.matchMedia(
          "(prefers-color-scheme: dark)"
        ).matches;
        if (prefersDark) {
          theme = "dark";
        } else {
          theme = "light";
        }
      }
    }

    setTheme(theme);

    const toggleTheme = () => {
      html.classList.contains("dark") ? setTheme("light") : setTheme("dark");
    };

    window.onload = () => {
      fixThemeToggleIcon(theme);

      let defaultActivePanel = document.querySelector(".accordion.active");
      if (defaultActivePanel) {
        defaultActivePanel.nextElementSibling.style.maxHeight =
          defaultActivePanel.nextElementSibling.scrollHeight + "px";
      }
    };

    window.onresize = () => {
      let defaultActivePanel = document.querySelector(".accordion.active");
      if (defaultActivePanel) {
        defaultActivePanel.nextElementSibling.style.maxHeight =
          defaultActivePanel.nextElementSibling.scrollHeight + "px";
      }
    };
  </script>
</head>
<body class="h-screen p-2 m-auto max-w-4xl flex flex-col">
    
    <header
  class="nav flex flex-row row py-2 mb-6 w-full border-b border-gray-700 dark:border-gray-300 justify-between"
>
  <div>
    <a class="nav-menu-item" href="https://nenadlazic.github.io/">Home</a>
    <a class="nav-menu-item" href="/blog">Blog</a>
  </div>
  <div>
    <a class="mr-4" href="/search">
      <i class="fas fa-search"></i>
    </a>
    <i
      class="fas fa-sun theme-toggle text-blue-500 hover:text-blue-700 dark:text-yellow-300 dark:hover:text-yellow-500 cursor-pointer text-lg mr-9 sm:mr-0"
      onclick="toggleTheme()"
    ></i>
  </div>
</header>



    
    <main class="grow">
<div class="prose prose-stone dark:prose-invert max-w-none">
<div class="mb-3">
  <h1 class="top-h1">How to expose Active Directory attributes in Keycloak tokens</h1>
  <p class="mb-1">August 18, 2025</p>
  <p>&mdash;</p>
</div>
<div class="content">
  <h2 id="introduction">Introduction</h2>
<p>In modern enterprises, <strong>centralized user directories</strong> are the backbone of identity management. Whether it’s Active Directory (AD) in large corporations or an LDAP server in smaller setups, the goal is simple: a single source of truth for user identities, used across networks and applications.</p>
<p>However, AD by itself is not a full IAM solution. This is where Keycloak comes into play: it acts as a layer that allows applications to leverage these identities for authentication and access management, while also providing the flexibility to enrich tokens with custom attributes from AD.</p>
<p><img src="/images/keycloacl-ad-diagram.png" alt="keycloak_ad_diagram"></p>
<p>For example, your service might require a custom claim such as <strong>employee number</strong> or <strong>department</strong> in the JWT token. This is a common enterprise use case: users are centrally managed in AD, but applications require customized identity information for authorization, auditing, or business logic.</p>
<p>In this blog post, we will walk through a <strong>practical example</strong> of how to:</p>
<ol>
<li>Integrate Keycloak with LDAP/AD user federation</li>
<li>Map AD attributes to Keycloak user attributes</li>
<li>Expose these attributes as custom claims in tokens</li>
</ol>
<p>Get ready to dive into LDAP mappers, protocol mappers, and migration scripts, demonstrating how a real-world enterprise scenario can be fully automated and production-ready.</p>
<h2 id="integrate-keycloak-with-ldapad-user-federation">Integrate Keycloak with LDAP/AD user federation</h2>
<p>Before you can map attributes or issue custom claims, Keycloak must <strong>connect to your LDAP/AD server</strong>. This is called <strong>user federation</strong>. Keycloak reads users directly from LDAP/AD server without duplicating passwords or managing accounts manually.</p>
<p>LDAP (Lightweight Directory Access Protocol) is the standard protocol used to query and interact with directory services like AD. It provides a structured, tree-like way of storing and retrieving information about users, groups, and resources in an enterprise network.</p>
<ol>
<li>
<p>Add a user federation provider</p>
<ul>
<li>In the <strong>Keycloak admin console</strong>, go to <strong>user federation</strong></li>
<li>Click <strong>add provider</strong> and select <strong>ldap</strong></li>
</ul>
</li>
<li>
<p>Configure the connection</p>
<p>Fill in your directory&rsquo;s details to establish the connection:</p>
<ul>
<li><strong>Connection URL:</strong> <code>ldap://&lt;your-ldap-ad-server-url&gt;</code></li>
<li><strong>Bind DN &amp; Credentials:</strong> Dedicated service account&rsquo;s login credentials. Keycloak uses this account to authenticate with LDAP/AD server and gain read-only access to user data.</li>
<li><strong>Users DN:</strong> Base path in your LDAP or AD where Keycloak begins its user search. It&rsquo;s like giving Keycloak a specific street address, such as OU=Users,DC=example,DC=com, to focus its search and improve performance.</li>
<li><strong>Vendor:</strong> Select <strong>Active Directory</strong>.</li>
<li><strong>Username LDAP attribute:</strong> This field defines the attribute in your LDAP or AD that Keycloak should use as the username for authentication. For AD, this is most often sAMAccountName.</li>
</ul>
<p>For better performance, set <strong>Import Enabled to true</strong> to cache users locally in Keycloak.</p>
</li>
<li>
<p>Test the connection</p>
<ul>
<li>Click <strong>test connection</strong> to ensure Keycloak can communicate with LDAP/AD server</li>
<li>Click <strong>test authentication</strong> using the bind DN credentials to verify authentication works</li>
</ul>
</li>
<li>
<p>Sync users</p>
<ul>
<li>After a successful connection, run a full sync to import all users from AD</li>
<li>Check that users appear in Keycloak’s users section</li>
</ul>
</li>
</ol>
<p>At this point, Keycloak knows about your AD users, but only basic fields like username, first name, last name, and email are available. Next, you can proceed to map additional AD attributes to Keycloak user attributes.</p>
<p><em>Note: You can fully automate all of this using Keycloak migration scripts as well. For more details and examples, see the official <a href="https://mayope.github.io/keycloakmigration/migrations/userfederation/#adduserfederation">Keycloak Server Migration documentation</a>.</em></p>
<h2 id="map-ad-attributes-to-keycloak-user-attributes">Map AD attributes to Keycloak user attributes</h2>
<p>Once AD users are visible in Keycloak, the next step is to bring in custom attributes from AD (e.g. employeeNumber, department&hellip;). By default, only a few basic fields (username, email, etc.) are mapped, so you need to explicitly configure LDAP mappers.</p>
<p>LDAP mappers define how attributes from AD are translated into Keycloak user attributes. For example, you can take the AD attribute departmentNumber and store it as a Keycloak user attribute called department.</p>
<ol>
<li>Add a new LDAP mapper
<ul>
<li>In the user federation screen, click your LDAP provider</li>
<li>Navigate to the Mappers tab</li>
<li>Click Create</li>
</ul>
</li>
<li>Configure the mapper
<ul>
<li>Name: A descriptive name (e.g. department_mapper)</li>
<li>Mapper type: user-attribute-ldap-mapper (most common choice)</li>
<li>User model attribute: Name of the attribute inside Keycloak (e.g. department)</li>
<li>LDAP attribute: The attribute from AD (e.g. departmentNumber)</li>
<li>Always read value from LDAP: Useful when you want to ensure Keycloak doesn’t cache stale values</li>
</ul>
</li>
<li>Save and sync users
<ul>
<li>After saving, re-run a sync to import or update attributes</li>
<li>Open a user in the Keycloak console and check that the new attribute is present</li>
</ul>
</li>
</ol>
<p>This mapping step is crucial, because only attributes available on the Keycloak user model can later be exposed as claims in tokens via protocol mappers.</p>
<h2 id="expose-these-attributes-as-custom-claims-in-tokens">Expose these attributes as custom claims in tokens</h2>
<p>Now that Keycloak has imported your AD attributes into its user model, you can make them available inside access tokens (JWTs) so that applications can consume them. This is done through protocol mappers.</p>
<p>Protocol mappers define how Keycloak includes user data in issued tokens. For example, you can expose a user’s department attribute from AD as a claim inside the access token.</p>
<ol>
<li>
<p>Navigate to the client</p>
<ul>
<li>In the Keycloak admin console, go to clients</li>
<li>Select the client that needs the custom claim</li>
</ul>
</li>
<li>
<p>Add a new protocol mapper</p>
<ul>
<li>Go to the mappers tab</li>
<li>Click create</li>
</ul>
</li>
<li>
<p>Configure the mapper</p>
<ul>
<li>Name: Descriptive name (e.g. department_claim)</li>
<li>Mapper type: user attribute</li>
<li>User attribute: The Keycloak user attribute you want to expose (e.g. department)</li>
<li>Token claim name: The JSON field in the token (e.g. department)</li>
<li>Claim JSON type: string (or another type if needed)</li>
<li>Add to access token: enabled</li>
<li>Add to ID token / userinfo: Optional, depending on your use case</li>
</ul>
</li>
<li>
<p>Test the tokens</p>
<ul>
<li>Log in with a user from AD who has the attribute</li>
<li>Decode the issued access token (e.g. using jwt.io)</li>
<li>Verify that the claim (e.g. &ldquo;department&rdquo;: &ldquo;Engineering&rdquo;) is present</li>
</ul>
</li>
</ol>
<p>This is the final step that allows your applications to make authorization decisions or apply business logic based on AD attributes delivered securely in tokens.</p>
<p><em>Note: Just like federation, LDAP mappers can also be fully managed via migration scripts (addAdLdapMapper). For details and YAML examples, see the <a href="https://mayope.github.io/keycloakmigration/migrations/client/#addclientmapper">migration scripts documentation</a>.</em></p>
<h2 id="conclusion">Conclusion</h2>
<p>By combining LDAP/AD federation, LDAP attribute mappers, and protocol mappers, Keycloak becomes a powerful bridge between your enterprise directory and modern applications. With this setup, attributes like department or employeeNumber seamlessly flow from AD into Keycloak tokens, enabling fine-grained authorization, auditing, and business logic without custom code.</p>
<p>Even better, the entire process can be automated with migration scripts, ensuring consistency across environments and deployments. This makes your identity layer both scalable and production-ready.</p>

</div>
</div>
<div class="flex flex-row justify-around my-2">
  <h3 class="mb-1 mt-1 text-left mr-4">
    
    <a
      href="/blog/keycloak-migration-scripts/"
      title="Keycloak migration scripts: your shortcut to consistent IAM"
    >
      <i class="nav-menu fas fa-chevron-circle-left"></i>
    </a>
    
  </h3>
  <h3 class="mb-1 mt-1 text-left ml-4">
    
    <a
      href="/blog/vmaf-introduction/"
      title="Understanding VMAF: Measuring video quality the right way"
    >
      <i class="nav-menu fas fa-chevron-circle-right"></i>
    </a>
    
  </h3>
</div>


    </main>
    
    <footer class="text-sm text-center border-t border-gray-500  py-6 ">
  <p class="markdownify">powered by <a href="https://gohugo.io/">hugo</a> &amp; deployed on <a href="https://pages.github.com/">GitHub Pages</a></p>
  <p >
    <i>
      <a href="https://nenadlazic.github.io/">
        © 2025
      </a>
    </i>
    by
    <a href="https://github.com/nenadlazic">
      Nenad Lazić
    </a>
  </p>

  
</footer>

    
  </body>
</html>
